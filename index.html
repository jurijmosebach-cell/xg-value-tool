<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Football xG Value Analyzer ‚öΩ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body class="bg-gray-100 text-gray-800">
    <div class="max-w-6xl mx-auto p-4">
      <!-- HEADER -->
      <header class="mb-6 flex flex-col sm:flex-row items-center justify-between">
        <h1 class="text-2xl font-bold mb-3 sm:mb-0">
          ‚öΩ Football Value Analyzer
        </h1>
        <div class="flex flex-wrap gap-3 items-center">
          <label class="text-sm">üìÖ Datum:</label>
          <input
            type="date"
            id="date"
            class="border border-gray-300 rounded-lg px-2 py-1 text-sm"
          />
          <label class="text-sm">üèÜ Liga:</label>
          <select
            id="league"
            class="border border-gray-300 rounded-lg px-2 py-1 text-sm"
          ></select>
          <button
            id="load"
            class="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700"
          >
            Spiele laden
          </button>
        </div>
      </header>

      <!-- STATUS -->
      <div id="status" class="text-gray-600 mb-4 text-sm"></div>

      <!-- TOP SECTIONS -->
      <div id="summary" class="space-y-6"></div>

      <!-- SPIELE -->
      <div id="games" class="grid gap-4 mt-6"></div>
    </div>

    <script>
      const dateInput = document.getElementById("date");
      const leagueSelect = document.getElementById("league");
      const loadBtn = document.getElementById("load");
      const gamesContainer = document.getElementById("games");
      const statusEl = document.getElementById("status");
      const summaryEl = document.getElementById("summary");

      dateInput.valueAsDate = new Date();

      // --- üèÜ Ligen dynamisch laden ---
      async function loadLeagues() {
        try {
          const res = await fetch("/api/leagues");
          const leagues = await res.json();

          leagues.forEach(l => {
            const opt = document.createElement("option");
            opt.value = l.key;
            opt.textContent = l.name;
            leagueSelect.appendChild(opt);
          });
        } catch (err) {
          console.error("Fehler beim Laden der Ligen:", err);
        }
      }
      loadLeagues();

      // --- üéØ Spiele laden ---
      loadBtn.addEventListener("click", loadGames);

      async function loadGames() {
        const date = dateInput.value;
        const league = leagueSelect.value;
        gamesContainer.innerHTML = "";
        summaryEl.innerHTML = "";
        statusEl.textContent = "‚è≥ Lade Spiele ...";

        try {
          const res = await fetch(`/api/games?date=${date}&leagues=${league}`);
          const data = await res.json();
          const games = data.response || [];

          if (!games.length) {
            statusEl.textContent = "‚ùå Keine Spiele gefunden.";
            return;
          }

          statusEl.textContent = `${games.length} Spiele geladen!`;
          renderSummary(games);
          renderGames(games);
        } catch (err) {
          console.error(err);
          statusEl.textContent = "‚ö†Ô∏è Fehler beim Laden der Spiele.";
        }
      }

      // --- üßÆ Zusammenfassung ---
      function renderSummary(games) {
        const topProb = [...games]
          .sort((a, b) =>
            Math.max(b.prob.home, b.prob.draw, b.prob.away) -
            Math.max(a.prob.home, a.prob.draw, a.prob.away)
          )
          .slice(0, 5)
          .map(
            g =>
              `<li>${g.home} vs ${g.away} ‚Üí <b>${
                ["Tipp 1", "Tipp X", "Tipp 2"][
                  [g.prob.home, g.prob.draw, g.prob.away].indexOf(
                    Math.max(g.prob.home, g.prob.draw, g.prob.away)
                  )
                ]
              }</b> (${(Math.max(
                g.prob.home,
                g.prob.draw,
                g.prob.away
              ) * 100).toFixed(1)}%)</li>`
          )
          .join("");

        const topValue = [...games]
          .sort((a, b) =>
            Math.max(b.value.home, b.value.draw, b.value.away) -
            Math.max(a.value.home, a.value.draw, a.value.away)
          )
          .slice(0, 5)
          .map(
            g =>
              `<li>${g.home} vs ${g.away} ‚Üí Beste Value: <b>${
                ["1", "X", "2"][
                  [g.value.home, g.value.draw, g.value.away].indexOf(
                    Math.max(g.value.home, g.value.draw, g.value.away)
                  )
                ]
              }</b> (${(Math.max(
                g.value.home,
                g.value.draw,
                g.value.away
              ) * 100).toFixed(1)}%)</li>`
          )
          .join("");

        summaryEl.innerHTML = `
          <section class="bg-white rounded-2xl p-4 shadow">
            <h2 class="font-bold text-lg mb-2">üèÖ Top 5 Wahrscheinlichkeit</h2>
            <ul class="list-disc ml-6 text-sm text-gray-700 space-y-1">${topProb}</ul>
          </section>
          <section class="bg-white rounded-2xl p-4 shadow">
            <h2 class="font-bold text-lg mb-2">üí∞ Top 5 Value</h2>
            <ul class="list-disc ml-6 text-sm text-gray-700 space-y-1">${topValue}</ul>
          </section>
        `;
      }

      // --- ‚öΩ Spielkarten ---
      function renderGames(games) {
        gamesContainer.innerHTML = games
          .map(g => {
            const bestTipIndex = [g.value.home, g.value.draw, g.value.away].indexOf(
              Math.max(g.value.home, g.value.draw, g.value.away)
            );
            const tipNames = ["Heimsieg", "Unentschieden", "Ausw√§rtssieg"];
            const tip = tipNames[bestTipIndex];
            const probPercent = Math.max(
              g.prob.home,
              g.prob.draw,
              g.prob.away
            ) * 100;

            return `
              <div class="bg-white rounded-2xl shadow p-4">
                <div class="flex justify-between items-center mb-2">
                  <h3 class="font-semibold text-lg">${g.home} vs ${g.away}</h3>
                  <span class="text-sm text-gray-500">${g.league}</span>
                </div>

                <div class="grid grid-cols-2 gap-2 mb-3">
                  <div>
                    <p class="text-sm text-gray-500">Heim xG:</p>
                    <div class="w-full bg-gray-200 h-2 rounded-full">
                      <div class="bg-blue-500 h-2 rounded-full" style="width: ${Math.min(
                        g.homeXG * 50,
                        100
                      )}%"></div>
                    </div>
                  </div>
                  <div>
                    <p class="text-sm text-gray-500">Ausw√§rts xG:</p>
                    <div class="w-full bg-gray-200 h-2 rounded-full">
                      <div class="bg-red-500 h-2 rounded-full" style="width: ${Math.min(
                        g.awayXG * 50,
                        100
                      )}%"></div>
                    </div>
                  </div>
                </div>

                <div class="text-sm text-gray-600 mb-2">
                  üìà <b>${tip}</b> ‚Äì ${probPercent.toFixed(1)}% Wahrscheinlichkeit
                </div>

                <div class="flex flex-wrap gap-2 text-xs">
                  <span class="bg-emerald-100 text-emerald-700 px-2 py-1 rounded-full">Over 2.5: ${(g.prob.over25 * 100).toFixed(1)}%</span>
                  <span class="bg-amber-100 text-amber-700 px-2 py-1 rounded-full">BTTS Ja: ${(g.prob.btts * 100).toFixed(1)}%</span>
                </div>
              </div>
            `;
          })
          .join("");
      }
    </script>
  </body>
</html>
